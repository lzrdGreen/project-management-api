{% extends 'projectapp/base.html' %}

{% block title %}Task Detail{% endblock %}

{% block content %}
<h1>{{ task.title }}</h1>
<p>Project: <a href="{% url 'project_detail' task.project.id %}">{{ task.project.title }}</a></p>
<p>Milestone:
    {% if task.milestone %}
        <a href="{% url 'milestone_detail' task.milestone.id %}">{{ task.milestone.name }}</a>
    {% else %}
        (Not Assigned to a Milestone)
    {% endif %}
</p>

<p>Description: {{ task.description }}</p>
<p>Status: {{ task.status }}</p>
<p>Priority: {{task.get_priority_display}}</p>
<p>Start Date: {{ task.start_date|default:"(Not Set)" }}</p>
<p>Due Date: {{ task.due_date }}</p>
<p>Prerequisite Tasks:
    {% with prereqs=task.prerequisite_tasks.all %}
        {% if prereqs %}
            <ul>
            {% for prereq in prereqs %}
                <li>
                    <a href="{% url 'task_detail' prereq.id %}">{{ prereq.title }}</a> 
                    (Due: {{ prereq.due_date }})
                </li>
            {% endfor %}
            </ul>
        {% else %}
            <b>None</b> (Depends on: {{ task.project.title }})
        {% endif %}
    {% endwith %}
</p>

<!-- Display warning if task is overdue -->
{% if task.overdue %}
    <p class="overdue-warning">⚠️ This task is overdue!</p>
{% endif %}

<!-- Display tags as a list -->
<p>Tags:</p>
<ul>
    {% for tag in task.tags.all %}
        <li>{{ tag.name }}</li>
    {% empty %}
        <li>No tags assigned.</li>
    {% endfor %}
</ul>

<button onclick="window.location.href='{% url 'project_detail' task.project.id %}'">← Back to Project</button>
<button onclick="window.location.href='{% url 'task_edit' task.id %}'" 
    {% if not can_edit_task %}disabled{% endif %}>Edit Task</button>
<!-- Delete Task Button with Confirmation -->
<button 
onclick="confirmDeleteTask('{{ task.id }}')" 
{% if not can_delete_task %}disabled style="opacity: 0.85; cursor: not-allowed;"{% endif %}>
Delete
</button>

<!-- Inline form for deletion -->
<form id="deleteTaskForm-{{ task.id }}" action="{% url 'task_delete' task.id %}" method="POST" style="display:none;">
{% csrf_token %}
</form>


{% if not can_edit_task and not can_delete_task %}
    <p>Sorry, but you don't have permission to edit or delete this task.</p>
{% endif %}
<script>
    // JavaScript alert confirmation for deleting tasks
    function confirmDeleteTask(taskId) {
        if (confirm("Are you sure you want to delete this task?")) {
            document.getElementById(`deleteTaskForm-${taskId}`).submit();
        }
    }
</script>
{% endblock %}
